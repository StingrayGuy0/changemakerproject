<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg1: #0f172a;
    --bg2: #020617;
    --card-bg: rgba(255,255,255,0.05);
    --border: #38bdf8;
    --accent: #38bdf8;
    --accent2: #0ea5e9;
    --text: #e2e8f0;
  }
  body {
    background: radial-gradient(circle at center, var(--bg1), var(--bg2));
    font-family: 'Orbitron', sans-serif;
    color: var(--text);
    margin: 0;
    padding: 1.5rem;
    text-align: center;
  }
  h1 {
    color: var(--accent);
    margin-bottom: 1.5rem;
  }
  .card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 1.2rem;
    margin: 1rem auto;
    max-width: 600px;
    backdrop-filter: blur(8px);
    box-shadow: 0 0 12px rgba(56,189,248,0.4);
    text-align: left;
  }
  .card h2 {
    margin-top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: var(--accent);
  }
  input, select, button {
    width: 100%;
    padding: 0.6rem;
    margin: 0.4rem 0;
    border-radius: 0.6rem;
    border: none;
    font-family: inherit;
    font-size: 0.95rem;
  }
  input, select {
    background: rgba(255,255,255,0.08);
    color: var(--text);
  }
  button {
    background: var(--accent);
    color: #000;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  button:hover {
    transform: scale(1.03);
    box-shadow: 0 0 12px var(--accent), 0 0 24px var(--accent2);
  }
  .status {
    margin-top: 0.6rem;
    font-size: 0.9rem;
    color: var(--accent);
  }
  .collapse-toggle {
    background: none;
    border: none;
    color: var(--accent);
    font-size: 1rem;
    cursor: pointer;
  }
  .task-list {
    margin-top: 1rem;
    max-height: 400px;
    overflow-y: auto;
    font-size: 0.9rem;
  }
  .task-item {
    border-bottom: 1px solid rgba(56,189,248,0.3);
    padding: 0.6rem 0;
  }
  .task-title {
    font-weight: bold;
    color: var(--accent);
  }
  .task-meta {
    color: #94a3b8;
    font-size: 0.85rem;
    margin-top: 0.2rem;
  }
</style>
</head>
<body>
<h1>✨ Teacher Dashboard</h1>

<!-- Task Creation Card -->
<div class="card">
  <h2>
    Create Task
    <button id="toggleTaskCard" class="collapse-toggle">−</button>
  </h2>
  <div id="taskCardBody">
    <input type="text" id="taskTitle" placeholder="Task Title">
    <input type="number" id="taskUP" placeholder="Upgrade Points Reward">
    <label for="studentSelect">Assign to Students:</label>
    <select id="studentSelect" multiple size="6"></select>
    <button onclick="createTask()">Assign Task</button>
    <p id="status" class="status"></p>
  </div>
</div>

<!-- View Tasks Card -->
<div class="card">
  <h2>
    View Tasks
    <button id="toggleViewTasks" class="collapse-toggle">−</button>
  </h2>
  <div id="viewTasksBody" style="display:block;">
    <div id="taskList" class="task-list"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { 
  getFirestore, collection, getDocs, addDoc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOAHU1cXBuW3PgyXtdLWGkZ2ayAKfCYBc",
  authDomain: "changemaker-fa1fd.firebaseapp.com",
  projectId: "changemaker-fa1fd",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusEl = document.getElementById("status");
const studentSelect = document.getElementById("studentSelect");
const taskListEl = document.getElementById("taskList");

// Wait for auth
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  // load students only after auth
  await loadStudents();
  subscribeTasks();
});

// Load students from Firestore
async function loadStudents() {
  studentSelect.innerHTML = "<option disabled>Loading students...</option>";
  try {
    const snap = await getDocs(collection(db, "users"));
    studentSelect.innerHTML = "";
    snap.forEach(docSnap => {
      const data = docSnap.data();
      if (data.role === "student") {
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = data.email || docSnap.id;
        studentSelect.appendChild(option);
      }
    });
    if (studentSelect.options.length === 0) {
      studentSelect.innerHTML = "<option disabled>No students found</option>";
    }
  } catch (err) {
    statusEl.textContent = " Error loading students: " + err.message;
  }
}

// Create task
async function createTask() {
  const title = document.getElementById("taskTitle").value.trim();
  const up = Number(document.getElementById("taskUP").value);
  const selectedOptions = Array.from(studentSelect.selectedOptions);
  const studentUIDs = selectedOptions.map(opt => opt.value);

  if (!title || isNaN(up) || up <= 0 || studentUIDs.length === 0) {
    statusEl.textContent = "Please fill all fields, enter a positive UP, and select at least one student.";
    return;
  }

  try {
    await addDoc(collection(db, "tasks"), {
      title,
      upReward: up,
      assignedTo: studentUIDs, 
      completedBy: []
    });
    statusEl.textContent = `Task "${title}" assigned to ${studentUIDs.length} student(s)!`;
    document.getElementById("taskTitle").value = "";
    document.getElementById("taskUP").value = "";
    studentSelect.selectedIndex = -1;
  } catch (err) {
    statusEl.textContent = "Error creating task: " + err.message;
  }
}

// Real-time tasks
function subscribeTasks() {
  const tasksRef = collection(db, "tasks");
  onSnapshot(tasksRef, (snapshot) => {
    taskListEl.innerHTML = "";
    if (snapshot.empty) {
      taskListEl.innerHTML = "<p>No tasks created yet.</p>";
      return;
    }
    snapshot.forEach(docSnap => {
      const task = docSnap.data();
      const item = document.createElement("div");
      item.classList.add("task-item");
      item.innerHTML = `
        <div class="task-title">${task.title} — <span>${task.upReward} UP</span></div>
        <div class="task-meta">Assigned: ${task.assignedTo?.length || 0} | Completed: ${task.completedBy?.length || 0}</div>
      `;
      taskListEl.appendChild(item);
    });
  }, (err) => {
    taskListEl.innerHTML = "<p>Error loading tasks: " + err.message + "</p>";
  });
}

window.createTask = createTask;

// Collapsibles
function setupCollapsible(toggleId, bodyId) {
  const toggleBtn = document.getElementById(toggleId);
  const body = document.getElementById(bodyId);
  let collapsed = false;
  toggleBtn.addEventListener("click", () => {
    collapsed = !collapsed;
    body.style.display = collapsed ? "none" : "block";
    toggleBtn.textContent = collapsed ? "+" : "−";
  });
}
setupCollapsible("toggleTaskCard", "taskCardBody");
setupCollapsible("toggleViewTasks", "viewTasksBody");
</script>
</body>
</html>
